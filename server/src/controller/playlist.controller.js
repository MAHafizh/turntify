import dotenv from "dotenv";
import mongoose from "mongoose";
import { successResponse } from "../utils/response.js";
import { Playlist } from "../models/playlist.model.js";
import { uploadToCloudinary } from "../utils/UploadToCloudinary.js";
import { deleteFromCloudinary } from "../utils/DeleteFromCloudinary.js";
import { User } from "../models/user.model.js";
import { AppError } from "../utils/ErrorHandler.js";

export const getPlaylist = async (req, res, next) => {
  const userId = req.user._id;
  try {
    const playlist = await Playlist.find({
      $or: [{ createdBy: userId }, { collaborators: userId }],
    }).populate({
      path: "songs",
      populate: {
        path: "song",
        select: "title",
      },
    });
    return successResponse(res, 200, playlist);
  } catch (error) {
    next(error);
  }
};

export const getPlaylistById = async (req, res, next) => {
  try {
    const { id } = req.params;
    const playlistExist = await Playlist.exists({ _id: id });
    if (!playlistExist) throw new AppError("Playlist not found", 404);
    const playlist = await Playlist.findById(id).populate({
      path: "songs",
      populate: {
        path: "song",
        select: "title duration",
      },
    });
    let totalDuration = 0;
    playlist.songs.map((s) => {
      totalDuration += s.song.duration;
    });
    console.log(totalDuration);
    return successResponse(res, 200, {
      ...playlist.toObject(),
      duration: totalDuration,
    });
  } catch (error) {
    next(error);
  }
};

export const createPlaylist = async (req, res, next) => {
  const session = await mongoose.startSession();
  session.startTransaction();

  const userId = req.user._id;
  const { title, description } = req.body || {};
  let imageUrl = process.env.DEFAULT_IMAGE;

  try {
    if (!req.body) throw new AppError("You're not input anything", 400);
    if (req.files?.imageFile)
      imageUrl = await uploadToCloudinary(req.files.imageFile);

    const playlist = new Playlist({
      title,
      imageUrl,
      createdBy: userId,
    });
    if (description !== undefined) playlist.description = description;

    const createdPlaylist = await playlist.save({ session });

    await User.findByIdAndUpdate(
      userId,
      {
        $addToSet: { playlists: createdPlaylist._id },
      },
      { session },
    );
    await session.commitTransaction();
    session.endSession();
    return successResponse(res, 201, createdPlaylist);
  } catch (error) {
    await session.abortTransaction();
    if (imageUrl && imageUrl !== process.env.DEFAULT_IMAGE)
      await deleteFromCloudinary(imageUrl);
    next(error);
  }
};

export const updatePlaylist = async (req, res, next) => {
  const { id } = req.params;
  const { title, visibility, description } = req.body || {};
  const userId = req.user._id;
  let newImageUrl;
  let oldImageUrl;

  try {
    const playlist = await Playlist.findOne({ _id: id, createdBy: userId });
    if (!playlist) throw new AppError("Playlist not found", 404);

    if (title !== undefined) playlist.title = title;
    if (visibility !== undefined) playlist.visibility = visibility;
    if (description !== undefined) playlist.description = description;

    if (req.files?.imageFile) {
      oldImageUrl = playlist.imageUrl;
      newImageUrl = await uploadToCloudinary(req.files.imageFile);
      playlist.imageUrl = newImageUrl;
    }
    const updatedPlaylist = await playlist.save();
    if (updatedPlaylist) {
      if (oldImageUrl && oldImageUrl !== process.env.DEFAULT_IMAGE)
        await deleteFromCloudinary(oldImageUrl);
      return successResponse(res, 200, updatedPlaylist);
    }
  } catch (error) {
    if (newImageUrl) await deleteFromCloudinary(newImageUrl);
    next(error);
  }
};

export const deletePlaylist = async (req, res, next) => {
  const { id } = req.params;
  const userId = req.user._id;
  try {
    const playlist = await Playlist.findOne({ _id: id, createdBy: userId });
    if (!playlist) throw new AppError("Playlist not found", 404);
    const deletedPlaylist = await Playlist.findByIdAndDelete(id);
    if (deletedPlaylist) {
      if (playlist.imageUrl && playlist.imageUrl !== process.env.DEFAULT_IMAGE)
        await deleteFromCloudinary(playlist.imageUrl);
      return successResponse(res, 200);
    }
  } catch (error) {
    next(error);
  }
};

export const addCollaboratorToPlaylist = async (req, res, next) => {
  const { playlistId, collaboratorId } = req.params;
  const userId = req.user._id;
  try {
    const exist = await User.exists({ _id: collaboratorId });
    if (!exist) throw new AppError("User not found", 404);

    const playlist = await Playlist.findOneAndUpdate(
      {
        _id: playlistId,
        createdBy: userId,
        collaborators: { $ne: collaboratorId },
      },
      { $addToSet: { collaborators: collaboratorId } },
      { new: true },
    );
    if (!playlist) throw new AppError("User already added", 400);
    return successResponse(res, 200, playlist);
  } catch (error) {
    next(error);
  }
};

export const removeCollaboratorFromPlaylist = async (req, res, next) => {
  const { playlistId, collaboratorId } = req.params;
  const userId = req.user._id;
  try {
    const playlist = await Playlist.findOneAndUpdate(
      { _id: playlistId, createdBy: userId, collaborators: collaboratorId },
      { $pull: { collaborators: collaboratorId } },
      { new: true },
    );
    return successResponse(res, 200, playlist);
  } catch (error) {
    next(error);
  }
};
